var T=t=>{throw TypeError(t)};var M=(t,r,n)=>r.has(t)||T("Cannot "+n);var w=(t,r,n)=>(M(t,r,"read from private field"),n?n.call(t):r.get(t)),I=(t,r,n)=>r.has(t)?T("Cannot add the same private member more than once"):r instanceof WeakSet?r.add(t):r.set(t,n);import{d as L,r as D,b as C,w as N,g as _,e as B,n as F,u as V,t as H,i as J,f as S,h as $,j as O,k as q,l as K}from"./2hbKoQD0.js";function X(t,r){if(typeof t!="string")throw new TypeError("argument str must be a string");const n={},e=r||{},o=e.decode||Y;let i=0;for(;i<t.length;){const a=t.indexOf("=",i);if(a===-1)break;let s=t.indexOf(";",i);if(s===-1)s=t.length;else if(s<a){i=t.lastIndexOf(";",a-1)+1;continue}const u=t.slice(i,a).trim();if(e!=null&&e.filter&&!(e!=null&&e.filter(u))){i=s+1;continue}if(n[u]===void 0){let d=t.slice(a+1,s).trim();d.codePointAt(0)===34&&(d=d.slice(1,-1)),n[u]=G(d,o)}i=s+1}return n}function Y(t){return t.includes("%")?decodeURIComponent(t):t}function G(t,r){try{return r(t)}catch{return t}}const b=/^[\u0009\u0020-\u007E\u0080-\u00FF]+$/;function z(t,r,n){const e=n||{},o=e.encode||encodeURIComponent;if(typeof o!="function")throw new TypeError("option encode is invalid");if(!b.test(t))throw new TypeError("argument name is invalid");const i=o(r);if(i&&!b.test(i))throw new TypeError("argument val is invalid");let a=t+"="+i;if(e.maxAge!==void 0&&e.maxAge!==null){const s=e.maxAge-0;if(Number.isNaN(s)||!Number.isFinite(s))throw new TypeError("option maxAge is invalid");a+="; Max-Age="+Math.floor(s)}if(e.domain){if(!b.test(e.domain))throw new TypeError("option domain is invalid");a+="; Domain="+e.domain}if(e.path){if(!b.test(e.path))throw new TypeError("option path is invalid");a+="; Path="+e.path}if(e.expires){if(!Q(e.expires)||Number.isNaN(e.expires.valueOf()))throw new TypeError("option expires is invalid");a+="; Expires="+e.expires.toUTCString()}if(e.httpOnly&&(a+="; HttpOnly"),e.secure&&(a+="; Secure"),e.priority)switch(typeof e.priority=="string"?e.priority.toLowerCase():e.priority){case"low":{a+="; Priority=Low";break}case"medium":{a+="; Priority=Medium";break}case"high":{a+="; Priority=High";break}default:throw new TypeError("option priority is invalid")}if(e.sameSite)switch(typeof e.sameSite=="string"?e.sameSite.toLowerCase():e.sameSite){case!0:{a+="; SameSite=Strict";break}case"lax":{a+="; SameSite=Lax";break}case"strict":{a+="; SameSite=Strict";break}case"none":{a+="; SameSite=None";break}default:throw new TypeError("option sameSite is invalid")}return e.partitioned&&(a+="; Partitioned"),a}function Q(t){return Object.prototype.toString.call(t)==="[object Date]"||t instanceof Date}function U(t){return typeof t=="string"?`'${t}'`:new Z().serialize(t)}const Z=function(){var r;class t{constructor(){I(this,r,new Map)}compare(e,o){const i=typeof e,a=typeof o;return i==="string"&&a==="string"?e.localeCompare(o):i==="number"&&a==="number"?e-o:String.prototype.localeCompare.call(this.serialize(e,!0),this.serialize(o,!0))}serialize(e,o){if(e===null)return"null";switch(typeof e){case"string":return o?e:`'${e}'`;case"bigint":return`${e}n`;case"object":return this.$object(e);case"function":return this.$function(e)}return String(e)}serializeObject(e){const o=Object.prototype.toString.call(e);if(o!=="[object Object]")return this.serializeBuiltInType(o.length<10?`unknown:${o}`:o.slice(8,-1),e);const i=e.constructor,a=i===Object||i===void 0?"":i.name;if(a!==""&&globalThis[a]===i)return this.serializeBuiltInType(a,e);if(typeof e.toJSON=="function"){const s=e.toJSON();return a+(s!==null&&typeof s=="object"?this.$object(s):`(${this.serialize(s)})`)}return this.serializeObjectEntries(a,Object.entries(e))}serializeBuiltInType(e,o){const i=this["$"+e];if(i)return i.call(this,o);if(typeof(o==null?void 0:o.entries)=="function")return this.serializeObjectEntries(e,o.entries());throw new Error(`Cannot serialize ${e}`)}serializeObjectEntries(e,o){const i=Array.from(o).sort((s,u)=>this.compare(s[0],u[0]));let a=`${e}{`;for(let s=0;s<i.length;s++){const[u,d]=i[s];a+=`${this.serialize(u,!0)}:${this.serialize(d)}`,s<i.length-1&&(a+=",")}return a+"}"}$object(e){let o=w(this,r).get(e);return o===void 0&&(w(this,r).set(e,`#${w(this,r).size}`),o=this.serializeObject(e),w(this,r).set(e,o)),o}$function(e){const o=Function.prototype.toString.call(e);return o.slice(-15)==="[native code] }"?`${e.name||""}()[native]`:`${e.name}(${e.length})${o.replace(/\s*\n\s*/g,"")}`}$Array(e){let o="[";for(let i=0;i<e.length;i++)o+=this.serialize(e[i]),i<e.length-1&&(o+=",");return o+"]"}$Date(e){try{return`Date(${e.toISOString()})`}catch{return"Date(null)"}}$ArrayBuffer(e){return`ArrayBuffer[${new Uint8Array(e).join(",")}]`}$Set(e){return`Set${this.$Array(Array.from(e).sort((o,i)=>this.compare(o,i)))}`}$Map(e){return this.serializeObjectEntries("Map",e.entries())}}r=new WeakMap;for(const n of["Error","RegExp","URL"])t.prototype["$"+n]=function(e){return`${n}(${e})`};for(const n of["Int8Array","Uint8Array","Uint8ClampedArray","Int16Array","Uint16Array","Int32Array","Uint32Array","Float32Array","Float64Array"])t.prototype["$"+n]=function(e){return`${n}[${e.join(",")}]`};for(const n of["BigInt64Array","BigUint64Array"])t.prototype["$"+n]=function(e){return`${n}[${e.join("n,")}${e.length>0?"n":""}]`};return t}();function W(t,r){return t===r||U(t)===U(r)}function h(t){if(typeof t!="object")return t;var r,n,e=Object.prototype.toString.call(t);if(e==="[object Object]"){if(t.constructor!==Object&&typeof t.constructor=="function"){n=new t.constructor;for(r in t)t.hasOwnProperty(r)&&n[r]!==t[r]&&(n[r]=h(t[r]))}else{n={};for(r in t)r==="__proto__"?Object.defineProperty(n,r,{value:h(t[r]),configurable:!0,enumerable:!0,writable:!0}):n[r]=h(t[r])}return n}if(e==="[object Array]"){for(r=t.length,n=Array(r);r--;)n[r]=h(t[r]);return n}return e==="[object Set]"?(n=new Set,t.forEach(function(o){n.add(h(o))}),n):e==="[object Map]"?(n=new Map,t.forEach(function(o,i){n.set(h(i),h(o))}),n):e==="[object Date]"?new Date(+t):e==="[object RegExp]"?(n=new RegExp(t.source,t.flags),n.lastIndex=t.lastIndex,n):e==="[object DataView]"?new t.constructor(h(t.buffer)):e==="[object ArrayBuffer]"?t.slice(0):e.slice(-6)==="Array]"?new t.constructor(t):t}const ee={path:"/",watch:!0,decode:t=>L(decodeURIComponent(t)),encode:t=>encodeURIComponent(typeof t=="string"?t:JSON.stringify(t))},k=window.cookieStore;function j(t,r){var d;const n={...ee,...r};n.filter??(n.filter=f=>f===t);const e=x(n)||{};let o;n.maxAge!==void 0?o=n.maxAge*1e3:n.expires&&(o=n.expires.getTime()-Date.now());const i=o!==void 0&&o<=0,a=i||e[t]===void 0||e[t]===null,s=h(i?void 0:e[t]??((d=n.default)==null?void 0:d.call(n))),u=o&&!i?ne(s,o,n.watch&&n.watch!=="shallow"):D(s);{let f=null;try{!k&&typeof BroadcastChannel<"u"&&(f=new BroadcastChannel(`nuxt:cookies:${t}`))}catch{}const m=(c=!1)=>{!c&&(n.readonly||W(u.value,e[t]))||(re(t,u.value,n),e[t]=h(u.value),f==null||f.postMessage({value:n.encode(u.value)}))},g=c=>{var v;const p=c.refresh?(v=x(n))==null?void 0:v[t]:n.decode(c.value);l=!0,u.value=p,e[t]=h(p),F(()=>{l=!1})};let l=!1;const y=!!_();if(y&&C(()=>{l=!0,m(),f==null||f.close()}),k){const c=p=>{const v=p.changed.find(A=>A.name===t),P=p.deleted.find(A=>A.name===t);v&&g({value:v.value}),P&&g({value:null})};k.addEventListener("change",c),y&&C(()=>k.removeEventListener("change",c))}else f&&(f.onmessage=({data:c})=>g(c));n.watch&&N(u,()=>{l||m()},{deep:n.watch!=="shallow"}),a&&m(a)}return u}function x(t={}){return X(document.cookie,t)}function te(t,r,n={}){return r==null?z(t,r,{...n,maxAge:-1}):z(t,r,n)}function re(t,r,n={}){document.cookie=te(t,r,n)}const R=2147483647;function ne(t,r,n){let e,o,i=0;const a=n?D(t):{value:t};return _()&&C(()=>{o==null||o(),clearTimeout(e)}),B((s,u)=>{n&&(o=N(a,u));function d(){i=0,clearTimeout(e);const f=r-i,m=f<R?f:R;e=setTimeout(()=>{if(i+=m,i<r)return d();a.value=void 0,u()},m)}return{get(){return s(),a.value},set(f){d(),a.value=f,u()}}})}const oe="$s";function E(...t){const r=typeof t[t.length-1]=="string"?t.pop():void 0;typeof t[0]!="string"&&t.unshift(r);const[n,e]=t;if(!n||typeof n!="string")throw new TypeError("[nuxt] [useState] key must be a string: "+n);if(e!==void 0&&typeof e!="function")throw new Error("[nuxt] [useState] init must be a function: "+e);const o=oe+n,i=V(),a=H(i.payload.state,o);if(a.value===void 0&&e){const s=e();if(J(s))return i.payload.state[o]=s,s;a.value=s}return a}const ie=()=>{const t=j("auth.user",{default:()=>null,maxAge:604800,sameSite:"lax",secure:!0}),r=E("auth.user",()=>t.value),n=E("auth.loading",()=>!1),e=E("auth.error",()=>""),o=async(l,y)=>{var c;n.value=!0,e.value="";try{const p=await $fetch("/api/auth/login",{method:"POST",body:{email:l,password:y}});if(p.success&&p.data.user&&p.data.token)return r.value=p.data.user,t.value=p.data.user,{success:!0};throw new Error("Invalid response from server")}catch(p){return console.error("Login error:",p),(c=p.data)!=null&&c.message?e.value=p.data.message:p.message==="Invalid login credentials"?e.value="ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä ÿ£Ÿà ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠ÿ©":e.value="ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ",{success:!1,error:e.value}}finally{n.value=!1}},i=async()=>{try{const l=await $fetch("/api/auth/logout",{method:"POST"});console.log("Logout response:",l.message)}catch(l){console.error("Logout error:",l)}finally{r.value=null,t.value=null;const l=j("auth-token");l.value=null,await O("/admin/login")}},a=async(l=!1)=>{if(r.value)return l||console.log("üë§ User already in state:",r.value.email,"role:",r.value.role),r.value;const y=j("auth-token");if(!y.value)return l||console.log("üîç No auth token found in cookie"),r.value=null,null;try{l||console.log("üîç Fetching user data from API...");const c=await $fetch("/api/auth/me");return c.success&&c.data.user?(r.value=c.data.user,t.value=c.data.user,l||console.log("‚úÖ User authenticated:",r.value.email,"role:",r.value.role),r.value):(l||console.log("‚ùå Invalid response from auth API"),r.value=null,t.value=null,null)}catch(c){return!l&&c.statusCode!==401&&console.error("‚ùå Auth check error:",c),r.value=null,t.value=null,c.statusCode===401&&(y.value=null,l||console.log("üîí Cleared invalid token")),null}},s=async()=>{if(!r.value)return null;try{const l=await $fetch("/api/auth/me");return l.success&&l.data.user?(r.value=l.data.user,t.value=l.data.user,r.value):(r.value=null,t.value=null,null)}catch(l){return console.error("Refresh user error:",l),r.value=null,t.value=null,null}},u=l=>!r.value||!r.value.permissions?!1:r.value.permissions[l]===!0,d=l=>!r.value||!r.value.role?!1:Array.isArray(l)?l.includes(r.value.role):r.value.role===l,f=S(()=>d(["admin","super_admin","moderator"])),m=S(()=>d("super_admin")),g=S(()=>{var l;return(l=r.value)!=null&&l.full_name?r.value.full_name.split(" ").map(y=>y.charAt(0)).slice(0,2).join("").toUpperCase():"AD"});return{user:$(r),loading:$(n),error:$(e),isAdmin:f,isSuperAdmin:m,userInitials:g,login:o,logout:i,checkAuth:a,refreshUser:s,hasPermission:u,hasRole:d}},le=q(async t=>{let r,n;if(console.log("üöÄ Admin middleware called for:",t.path),t.path==="/admin/login"){console.log("‚è≠Ô∏è Skipping middleware for login page");return}const{user:e,checkAuth:o}=ie();let i=e.value;if(i)console.log("‚úÖ User already authenticated from cookie:",i.email);else{console.log("üë§ No user in state, checking auth...");try{i=([r,n]=K(()=>o(!0)),r=await r,n(),r)}catch(a){return console.error("‚ùå Auth check failed:",a),O("/admin/login")}}if(!i||!i.role||!["admin","super_admin","moderator"].includes(i.role))return console.log("‚ùå No authenticated admin user found, redirecting to login"),O("/admin/login");console.log("‚úÖ User has admin privileges:",i.email,"role:",i.role),console.log("‚úÖ Middleware completed successfully for:",t.path)});export{le as default};
