import{c as e,r as o,u as a,e as t,j as n,k as s}from"../../_/nitro.mjs";import{executeQuery as i}from"../../_/database.mjs";import r from"twilio";import"node:http";import"node:https";import"node:events";import"node:buffer";import"vue";import"node:fs";import"node:url";import"@iconify/utils";import"node:crypto";import"consola";import"node:module";import"ipx";import"node:path";import"mysql2/promise";import"bcryptjs";import"jsonwebtoken";const c=e((async e=>{try{const c=await o(e),l=a(),{name:m,email:p,phone:d,message:u,packageId:g,packageName:f,locale:w="ar-SA"}=c;if(!m||!u)throw t({statusCode:400,statusMessage:"Name and message are required"});let h;console.log("📦 Package inquiry received:",{name:m,email:p||null,phone:d||null,message:u,packageId:g,packageName:f,locale:w});try{h=await i("\n        INSERT INTO contact_messages (\n          name, email, phone, subject, message, type, status, source,\n          related_package_id, ip_address, user_agent, created_at, updated_at\n        ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, NOW(), NOW())\n      ",[m,p||null,d||null,`استفسار عن ${f}`,u,"booking","new","website",g||null,n(e,{xForwardedFor:!0})||"127.0.0.1",s(e,"user-agent")||"Unknown"]),console.log("✅ Database insert successful:",h)}catch(e){console.warn("⚠️ Database connection failed, using development fallback:",e.message),console.log("📝 Development mode: Package inquiry logged to console"),console.log("📦 Package Inquiry Details:",{name:m,email:p,phone:d,message:u,packageId:g,packageName:f,locale:w,timestamp:(new Date).toISOString()}),h={insertId:"dev-"+Date.now(),affectedRows:1}}let k=!1;if(l.twilioAccountSid&&l.twilioAuthToken&&l.twilioAccountSid.startsWith("AC")&&l.twilioWhatsAppNumber)try{const e=r(l.twilioAccountSid,l.twilioAuthToken),o=w.startsWith("ar")?`طلب حجز جديد!\n          \n    العميل: ${c.name}\n    البريد الإلكتروني: ${c.email}\n    الهاتف: ${c.phone}\n    الباقة: ${c.packageName}\n    الرسالة: ${c.message}`:`New Package Inquiry!\n          \n    Customer: ${c.name}\n    Email: ${c.email}\n    Phone: ${c.phone}\n    Package: ${c.packageName}\n    Message: ${c.message}`,a=await e.messages.create({from:`whatsapp:${l.twilioPhoneNumber}`,to:`whatsapp:${l.salesManagerPhone}`,body:o});k=!0,console.log("WhatsApp notification sent successfully:",a.sid)}catch(e){console.error("Twilio client error:",e),k=!1}else console.log("Twilio not configured - skipping WhatsApp notification");return{success:!0,inquiryId:h.insertId||0,notificationSent:k,...k?{notificationId:"sent"}:{error:"Twilio not configured"}}}catch(e){return console.error("Contact form submission failed:",e),{success:!1,error:e.message||"Failed to process contact form",notificationSent:!1}}}));export{c as default};
//# sourceMappingURL=package-contact-form.mjs.map
