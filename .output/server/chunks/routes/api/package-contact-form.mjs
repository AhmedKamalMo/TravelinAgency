import{c as e,r as t,u as o,e as a}from"../../_/nitro.mjs";import{executeQuery as s}from"../../_/database.mjs";import i from"twilio";import"node:http";import"node:https";import"node:events";import"node:buffer";import"vue";import"node:fs";import"node:url";import"@iconify/utils";import"node:crypto";import"consola";import"ipx";import"node:path";import"mysql2/promise";import"bcryptjs";import"jsonwebtoken";const n=e((async e=>{try{const n=await t(e),r=o(),{name:c,email:l,phone:m,message:p,packageId:u,packageName:d,locale:g="ar-SA"}=n;if(!c||!p)throw a({statusCode:400,statusMessage:"Name and message are required"});console.log("Inserting package inquiry with data:",{name:c,email:l||null,phone:m||null,message:p,packageId:u,packageName:d,locale:g});const f=await s("\n      INSERT INTO contact_messages (\n        name, email, phone, subject, message, type, status, source,\n        related_package_id, ip_address, user_agent, created_at, updated_at\n      ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, NOW(), NOW())\n    ",[c,l||null,m||null,`استفسار عن ${d}`,p,"booking","new","website",u||null,"127.0.0.1","Test User Agent"]);if(console.log("Database result:",f),!f||0===f.affectedRows)throw console.error("Database insert failed:",f),a({statusCode:500,statusMessage:"Failed to save package inquiry"});let h=!1;if(r.twilioAccountSid&&r.twilioAuthToken&&r.twilioAccountSid.startsWith("AC")&&r.twilioWhatsAppNumber)try{const e=i(r.twilioAccountSid,r.twilioAuthToken),t=g.startsWith("ar")?`طلب حجز جديد!\n          \n    العميل: ${n.name}\n    البريد الإلكتروني: ${n.email}\n    الهاتف: ${n.phone}\n    الباقة: ${n.packageName}\n    الرسالة: ${n.message}`:`New Package Inquiry!\n          \n    Customer: ${n.name}\n    Email: ${n.email}\n    Phone: ${n.phone}\n    Package: ${n.packageName}\n    Message: ${n.message}`,o=await e.messages.create({from:`whatsapp:${r.twilioPhoneNumber}`,to:`whatsapp:${r.salesManagerPhone}`,body:t});h=!0,console.log("WhatsApp notification sent successfully:",o.sid)}catch(e){console.error("Twilio client error:",e),h=!1}else console.log("Twilio not configured - skipping WhatsApp notification");return{success:!0,inquiryId:f.insertId||0,notificationSent:h,...h?{notificationId:"sent"}:{error:"Twilio not configured"}}}catch(e){return console.error("Contact form submission failed:",e),{success:!1,error:e.message||"Failed to process contact form",notificationSent:!1}}}));export{n as default};
//# sourceMappingURL=package-contact-form.mjs.map
