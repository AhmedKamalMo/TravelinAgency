import{c as e,r as t,u as o,e as i}from"../../_/nitro.mjs";import{executeQuery as n}from"../../_/database.mjs";import s from"twilio";import"node:http";import"node:https";import"node:events";import"node:buffer";import"vue";import"node:fs";import"node:url";import"@iconify/utils";import"node:crypto";import"consola";import"ipx";import"node:path";import"mysql2/promise";import"bcryptjs";import"jsonwebtoken";const a=e((async e=>{try{const a=await t(e),r=o(),{name:l,email:m,phone:c,message:d,destinationId:p,destinationName:u,locale:f="ar-SA"}=a;if(!l||!d)throw i({statusCode:400,statusMessage:"Name and message are required"});console.log("Inserting destination inquiry with data:",{name:l,email:m||null,phone:c||null,message:d,destinationId:p,destinationName:u,locale:f});const h=await n("\n      INSERT INTO contact_messages (\n        name, email, phone, subject, message, type, status, source,\n        related_destination_id, ip_address, user_agent, created_at, updated_at\n      ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, NOW(), NOW())\n    ",[l,m||null,c||null,`استفسار عن ${u}`,d,"general","new","website",p||null,"127.0.0.1","Test User Agent"]);if(console.log("Database result:",h),!h||0===h.affectedRows)throw console.error("Database insert failed:",h),i({statusCode:500,statusMessage:"Failed to save destination inquiry"});let g=!1;if(r.twilioAccountSid&&r.twilioAuthToken&&r.twilioAccountSid.startsWith("AC")&&r.twilioWhatsAppNumber)try{const e=s(r.twilioAccountSid,r.twilioAuthToken),t=f.startsWith("ar")?`طلب استفسار عن وجهة سياحية جديد!\n          \n    العميل: ${a.name}\n    البريد الإلكتروني: ${a.email}\n    الهاتف: ${a.phone}\n    الوجهة: ${a.destinationName}\n    الرسالة: ${a.message}`:`New Destination Inquiry!\n          \n    Customer: ${a.name}\n    Email: ${a.email}\n    Phone: ${a.phone}\n    Destination: ${a.destinationName}\n    Message: ${a.message}`,o=await e.messages.create({from:`whatsapp:${r.twilioPhoneNumber}`,to:`whatsapp:${r.salesManagerPhone}`,body:t});g=!0,console.log("WhatsApp notification sent successfully:",o.sid)}catch(e){console.error("Twilio client error for destination inquiry:",e),g=!1}else console.log("Twilio not configured - skipping WhatsApp notification");return{success:!0,inquiryId:h.insertId||0,notificationSent:g,...g?{notificationId:"sent"}:{error:"Twilio not configured"}}}catch(e){return console.error("Destination contact form submission failed:",e),{success:!1,error:e.message||"Failed to process destination contact form",notificationSent:!1}}}));export{a as default};
//# sourceMappingURL=destination-contact-form.mjs.map
