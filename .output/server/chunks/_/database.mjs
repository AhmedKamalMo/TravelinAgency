import{u as e}from"./nitro.mjs";import r from"mysql2/promise";import s from"bcryptjs";import n from"jsonwebtoken";let t=null;async function executeQuery(e,s=[]){const n=function(){if(!t){const e={host:process.env.DB_HOST||"localhost",port:Number(process.env.DB_PORT)||3306,user:process.env.DB_USER||"root",password:process.env.DB_PASSWORD||"",database:process.env.DB_NAME||"wonderland_travel"};console.log("ðŸ”§ MySQL Config:",{host:e.host,port:e.port,user:e.user,password:e.password?"[SET]":"[EMPTY]",database:e.database}),t=r.createPool({...e,charset:"utf8mb4",timezone:"+00:00",connectionLimit:10,queueLimit:0,waitForConnections:!0})}return t}();try{const[r]=await n.execute(e,s);return r}catch(e){throw console.error("Database query error:",e),e}}async function findOne(e,r=[]){const s=await executeQuery(e,r);return s.length>0?s[0]:null}function generateJWT(r,s="24h"){const t=e();return n.sign(r,t.jwtSecret,{expiresIn:s})}function verifyJWT(r){const s=e();try{return n.verify(r,s.jwtSecret)}catch(e){throw new Error("Invalid token")}}async function authenticateUser(e,r){try{const n=await findOne("SELECT * FROM users WHERE email = ?",[e]);if(!n)return null;const t=await async function(e,r){return await s.compare(e,r)}(r,n.password);if(!t)return null;const o=await findOne("SELECT * FROM admin_profiles WHERE user_id = ?",[n.id]);return{user:{...n,role:(null==o?void 0:o.role)||"admin",permissions:(null==o?void 0:o.permissions)?JSON.parse(o.permissions):{}}}}catch(e){return console.error("Authentication error:",e),null}}async function getUserById(e){const r=await findOne("\n    SELECT u.id, u.email, u.full_name, u.phone, u.status, u.created_at, u.updated_at,\n           ap.role, ap.permissions\n    FROM users u\n    LEFT JOIN admin_profiles ap ON u.id = ap.user_id\n    WHERE u.id = ?\n  ",[e]);if(r){if(r.permissions&&"string"==typeof r.permissions)try{r.permissions=JSON.parse(r.permissions)}catch(e){console.error("Error parsing permissions JSON:",e),r.permissions={}}else r.permissions||(r.permissions={});r.role||(r.role="admin")}return r}export{authenticateUser as a,getUserById as b,executeQuery as e,generateJWT as g,verifyJWT as v};
//# sourceMappingURL=database.mjs.map
