import{a as e}from"../../_/nitro.mjs";import{defineEventHandler as i,readBody as n,createError as o}from"file://F:/TravelinAgency/node_modules/h3/dist/index.mjs";import{e as s}from"../../_/database.mjs";import t from"file://F:/TravelinAgency/node_modules/twilio/lib/index.js";import"file://F:/TravelinAgency/node_modules/destr/dist/index.mjs";import"file://F:/TravelinAgency/node_modules/hookable/dist/index.mjs";import"file://F:/TravelinAgency/node_modules/ofetch/dist/node.mjs";import"file://F:/TravelinAgency/node_modules/node-mock-http/dist/index.mjs";import"file://F:/TravelinAgency/node_modules/klona/dist/index.mjs";import"file://F:/TravelinAgency/node_modules/defu/dist/defu.mjs";import"file://F:/TravelinAgency/node_modules/scule/dist/index.mjs";import"file://F:/TravelinAgency/node_modules/radix3/dist/index.mjs";import"file://F:/TravelinAgency/node_modules/vue/index.mjs";import"node:fs";import"node:url";import"file://F:/TravelinAgency/node_modules/pathe/dist/index.mjs";import"file://F:/TravelinAgency/node_modules/@iconify/utils/lib/index.mjs";import"file://F:/TravelinAgency/node_modules/ohash/dist/index.mjs";import"file://F:/TravelinAgency/node_modules/consola/dist/index.mjs";import"file://F:/TravelinAgency/node_modules/ipx/dist/index.mjs";import"file://F:/TravelinAgency/node_modules/unstorage/dist/index.mjs";import"file://F:/TravelinAgency/node_modules/unstorage/drivers/fs.mjs";import"file:///F:/TravelinAgency/node_modules/nuxt/dist/core/runtime/nitro/utils/cache-driver.js";import"file://F:/TravelinAgency/node_modules/unstorage/drivers/fs-lite.mjs";import"file://F:/TravelinAgency/node_modules/mysql2/promise.js";import"file://F:/TravelinAgency/node_modules/bcryptjs/index.js";import"file://F:/TravelinAgency/node_modules/jsonwebtoken/index.js";const a=i((async i=>{try{const a=await n(i),l=e(),{name:r,email:d,phone:m,message:c,destinationId:u,destinationName:f,locale:p="ar-SA"}=a;if(!r||!c)throw o({statusCode:400,statusMessage:"Name and message are required"});console.log("Inserting destination inquiry with data:",{name:r,email:d||null,phone:m||null,message:c,destinationId:u,destinationName:f,locale:p});const g=await s("\n      INSERT INTO contact_messages (\n        name, email, phone, subject, message, type, status, source,\n        related_destination_id, ip_address, user_agent, created_at, updated_at\n      ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, NOW(), NOW())\n    ",[r,d||null,m||null,`استفسار عن ${f}`,c,"general","new","website",u||null,"127.0.0.1","Test User Agent"]);if(console.log("Database result:",g),!g||0===g.affectedRows)throw console.error("Database insert failed:",g),o({statusCode:500,statusMessage:"Failed to save destination inquiry"});let y=!1;if(l.twilioAccountSid&&l.twilioAuthToken&&l.twilioAccountSid.startsWith("AC")&&l.twilioWhatsAppNumber)try{const e=t(l.twilioAccountSid,l.twilioAuthToken),i=p.startsWith("ar")?`طلب استفسار عن وجهة سياحية جديد!\n          \n    العميل: ${a.name}\n    البريد الإلكتروني: ${a.email}\n    الهاتف: ${a.phone}\n    الوجهة: ${a.destinationName}\n    الرسالة: ${a.message}`:`New Destination Inquiry!\n          \n    Customer: ${a.name}\n    Email: ${a.email}\n    Phone: ${a.phone}\n    Destination: ${a.destinationName}\n    Message: ${a.message}`,n=await e.messages.create({from:`whatsapp:${l.twilioPhoneNumber}`,to:`whatsapp:${l.salesManagerPhone}`,body:i});y=!0,console.log("WhatsApp notification sent successfully:",n.sid)}catch(e){console.error("Twilio client error for destination inquiry:",e),y=!1}else console.log("Twilio not configured - skipping WhatsApp notification");return{success:!0,inquiryId:g.insertId||0,notificationSent:y,...y?{notificationId:"sent"}:{error:"Twilio not configured"}}}catch(e){return console.error("Destination contact form submission failed:",e),{success:!1,error:e.message||"Failed to process destination contact form",notificationSent:!1}}}));export{a as default};
//# sourceMappingURL=destination-contact-form.mjs.map
