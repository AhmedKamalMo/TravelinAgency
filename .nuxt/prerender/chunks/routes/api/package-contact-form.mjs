import{a as e}from"../../_/nitro.mjs";import{defineEventHandler as n,readBody as i,createError as o,getRequestIP as s,getHeader as a}from"file://F:/TravelinAgency/node_modules/h3/dist/index.mjs";import{executeQuery as t}from"../../_/database.mjs";import l from"file://F:/TravelinAgency/node_modules/twilio/lib/index.js";import"file://F:/TravelinAgency/node_modules/destr/dist/index.mjs";import"file://F:/TravelinAgency/node_modules/hookable/dist/index.mjs";import"file://F:/TravelinAgency/node_modules/ofetch/dist/node.mjs";import"file://F:/TravelinAgency/node_modules/node-mock-http/dist/index.mjs";import"file://F:/TravelinAgency/node_modules/klona/dist/index.mjs";import"file://F:/TravelinAgency/node_modules/defu/dist/defu.mjs";import"file://F:/TravelinAgency/node_modules/scule/dist/index.mjs";import"file://F:/TravelinAgency/node_modules/radix3/dist/index.mjs";import"file://F:/TravelinAgency/node_modules/vue/index.mjs";import"node:fs";import"node:url";import"file://F:/TravelinAgency/node_modules/pathe/dist/index.mjs";import"file://F:/TravelinAgency/node_modules/@iconify/utils/lib/index.mjs";import"file://F:/TravelinAgency/node_modules/ohash/dist/index.mjs";import"file://F:/TravelinAgency/node_modules/consola/dist/index.mjs";import"file://F:/TravelinAgency/node_modules/ipx/dist/index.mjs";import"file://F:/TravelinAgency/node_modules/unstorage/dist/index.mjs";import"file://F:/TravelinAgency/node_modules/unstorage/drivers/fs.mjs";import"file:///F:/TravelinAgency/node_modules/nuxt/dist/core/runtime/nitro/utils/cache-driver.js";import"file://F:/TravelinAgency/node_modules/unstorage/drivers/fs-lite.mjs";import"file://F:/TravelinAgency/node_modules/mysql2/promise.js";import"file://F:/TravelinAgency/node_modules/bcryptjs/index.js";import"file://F:/TravelinAgency/node_modules/jsonwebtoken/index.js";const r=n((async n=>{try{const r=await i(n),d=e(),{name:m,email:c,phone:u,message:g,packageId:p,packageName:f,locale:y="ar-SA"}=r;if(!m||!g)throw o({statusCode:400,statusMessage:"Name and message are required"});let A;console.log("📦 Package inquiry received:",{name:m,email:c||null,phone:u||null,message:g,packageId:p,packageName:f,locale:y});try{A=await t("\n        INSERT INTO contact_messages (\n          name, email, phone, subject, message, type, status, source,\n          related_package_id, ip_address, user_agent, created_at, updated_at\n        ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, NOW(), NOW())\n      ",[m,c||null,u||null,`استفسار عن ${f}`,g,"booking","new","website",p||null,s(n,{xForwardedFor:!0})||"127.0.0.1",a(n,"user-agent")||"Unknown"]),console.log("✅ Database insert successful:",A)}catch(e){console.warn("⚠️ Database connection failed, using development fallback:",e.message),console.log("📝 Development mode: Package inquiry logged to console"),console.log("📦 Package Inquiry Details:",{name:m,email:c,phone:u,message:g,packageId:p,packageName:f,locale:y,timestamp:(new Date).toISOString()}),A={insertId:"dev-"+Date.now(),affectedRows:1}}let _=!1;if(d.twilioAccountSid&&d.twilioAuthToken&&d.twilioAccountSid.startsWith("AC")&&d.twilioWhatsAppNumber)try{const e=l(d.twilioAccountSid,d.twilioAuthToken),n=y.startsWith("ar")?`طلب حجز جديد!\n          \n    العميل: ${r.name}\n    البريد الإلكتروني: ${r.email}\n    الهاتف: ${r.phone}\n    الباقة: ${r.packageName}\n    الرسالة: ${r.message}`:`New Package Inquiry!\n          \n    Customer: ${r.name}\n    Email: ${r.email}\n    Phone: ${r.phone}\n    Package: ${r.packageName}\n    Message: ${r.message}`,i=await e.messages.create({from:`whatsapp:${d.twilioPhoneNumber}`,to:`whatsapp:${d.salesManagerPhone}`,body:n});_=!0,console.log("WhatsApp notification sent successfully:",i.sid)}catch(e){console.error("Twilio client error:",e),_=!1}else console.log("Twilio not configured - skipping WhatsApp notification");return{success:!0,inquiryId:A.insertId||0,notificationSent:_,..._?{notificationId:"sent"}:{error:"Twilio not configured"}}}catch(e){return console.error("Contact form submission failed:",e),{success:!1,error:e.message||"Failed to process contact form",notificationSent:!1}}}));export{r as default};
//# sourceMappingURL=package-contact-form.mjs.map
