import{useCookie as i}from"../node_modules/nuxt/dist/app/composables/cookie.mjs";import{useState as c}from"../node_modules/nuxt/dist/app/composables/state.mjs";import{navigateTo as C}from"../node_modules/nuxt/dist/app/composables/router.mjs";import{computed as v,readonly as f}from"vue";const _=()=>{const u=i("auth.user",{default:()=>null,maxAge:604800,sameSite:"lax",secure:process.env.NODE_ENV==="production"}),r=c("auth.user",()=>u.value),t=c("auth.loading",()=>!1),o=c("auth.error",()=>""),d=async(e,s)=>{var a;t.value=!0,o.value="";try{const l=await $fetch("/api/auth/login",{method:"POST",body:{email:e,password:s}});if(l.success&&l.data.user&&l.data.token)return r.value=l.data.user,u.value=l.data.user,{success:!0};throw new Error("Invalid response from server")}catch(l){return console.error("Login error:",l),(a=l.data)!=null&&a.message?o.value=l.data.message:l.message==="Invalid login credentials"?o.value="البريد الإلكتروني أو كلمة المرور غير صحيحة":o.value="حدث خطأ أثناء تسجيل الدخول",{success:!1,error:o.value}}finally{t.value=!1}},m=async()=>{try{const e=await $fetch("/api/auth/logout",{method:"POST"});console.log("Logout response:",e.message)}catch(e){console.error("Logout error:",e)}finally{r.value=null,u.value=null;const e=i("auth-token");e.value=null,await C("/admin/login")}},h=async(e=!1)=>{if(r.value)return e||console.log("👤 User already in state:",r.value.email,"role:",r.value.role),r.value;const s=i("auth-token");if(!s.value)return e||console.log("🔍 No auth token found in cookie"),r.value=null,null;try{e||console.log("🔍 Fetching user data from API...");const a=await $fetch("/api/auth/me");return a.success&&a.data.user?(r.value=a.data.user,u.value=a.data.user,e||console.log("✅ User authenticated:",r.value.email,"role:",r.value.role),r.value):(e||console.log("❌ Invalid response from auth API"),r.value=null,u.value=null,null)}catch(a){return!e&&a.statusCode!==401&&console.error("❌ Auth check error:",a),r.value=null,u.value=null,a.statusCode===401&&(s.value=null,e||console.log("🔒 Cleared invalid token")),null}},p=async()=>{if(!r.value)return null;try{const e=await $fetch("/api/auth/me");return e.success&&e.data.user?(r.value=e.data.user,u.value=e.data.user,r.value):(r.value=null,u.value=null,null)}catch(e){return console.error("Refresh user error:",e),r.value=null,u.value=null,null}},g=e=>!r.value||!r.value.permissions?!1:r.value.permissions[e]===!0,n=e=>!r.value||!r.value.role?!1:Array.isArray(e)?e.includes(r.value.role):r.value.role===e,y=v(()=>n(["admin","super_admin","moderator"])),k=v(()=>n("super_admin")),A=v(()=>{var e;return(e=r.value)!=null&&e.full_name?r.value.full_name.split(" ").map(s=>s.charAt(0)).slice(0,2).join("").toUpperCase():"AD"});return{user:f(r),loading:f(t),error:f(o),isAdmin:y,isSuperAdmin:k,userInitials:A,login:d,logout:m,checkAuth:h,refreshUser:p,hasPermission:g,hasRole:n}};export{_ as useAuth};
//# sourceMappingURL=useAuth.mjs.map
