#!/usr/bin/env node

console.log('ðŸ”§ FIXING API RESPONSE STRUCTURE');
console.log('=================================\n');

console.log('ðŸ“‹ FIXES FOR API RESPONSE STRUCTURE:');
console.log('====================================');
console.log('');
console.log('# 1. Update the API handler to match frontend expectations');
console.log('cat > api-handler-fixed-structure.php << "EOF"');
console.log('<?php');
console.log('// Set proper headers first');
console.log('header("Content-Type: application/json; charset=utf-8");');
console.log('header("Access-Control-Allow-Origin: *");');
console.log('header("Access-Control-Allow-Methods: GET, POST, PUT, DELETE, OPTIONS");');
console.log('header("Access-Control-Allow-Headers: Content-Type, Authorization, X-Requested-With");');
console.log('');
console.log('// Handle preflight requests');
console.log('if ($_SERVER["REQUEST_METHOD"] === "OPTIONS") {');
console.log('    http_response_code(200);');
console.log('    exit;');
console.log('}');
console.log('');
console.log('// Get the request path');
console.log('$uri = $_SERVER["REQUEST_URI"];');
console.log('$path = parse_url($uri, PHP_URL_PATH);');
console.log('');
console.log('// Remove any query parameters for path matching');
console.log('$path = strtok($path, \'?\');');
console.log('');
console.log('try {');
console.log('    switch ($path) {');
console.log('        case "/api/auth/login":');
console.log('            if ($_SERVER["REQUEST_METHOD"] !== "POST") {');
console.log('                http_response_code(405);');
console.log('                echo json_encode(["error" => "Method not allowed"], JSON_UNESCAPED_SLASHES);');
console.log('                break;');
console.log('            }');
console.log('');
console.log('            // Get JSON input');
console.log('            $input = json_decode(file_get_contents("php://input"), true);');
console.log('            if (json_last_error() !== JSON_ERROR_NONE) {');
console.log('                http_response_code(400);');
console.log('                echo json_encode(["error" => "Invalid JSON"], JSON_UNESCAPED_SLASHES);');
console.log('                break;');
console.log('            }');
console.log('');
console.log('            $email = $input["email"] ?? "";');
console.log('            $password = $input["password"] ?? "";');
console.log('');
console.log('            // Valid admin credentials');
console.log('            $validCredentials = [');
console.log('                "admin@worldtripagency.com" => "admin123",');
console.log('                "admin@wonderland.com" => "admin123",');
console.log('                "admin" => "admin"');
console.log('            ];');
console.log('');
console.log('            if (isset($validCredentials[$email]) && $validCredentials[$email] === $password) {');
console.log('                // Create a simple token');
console.log('                $token = base64_encode(json_encode([');
console.log('                    "email" => $email,');
console.log('                    "exp" => time() + 3600,');
console.log('                    "role" => "admin"');
console.log('                ]));');
console.log('');
console.log('                // Set token cookie');
console.log('                setcookie("auth-token", $token, time() + 3600, "/", "", false, true);');
console.log('');
console.log('                // Return success response in the format expected by frontend');
console.log('                echo json_encode([');
console.log('                    "success" => true,');
console.log('                    "data" => [');
console.log('                        "user" => [');
console.log('                            "email" => $email,');
console.log('                            "name" => "Admin User",');
console.log('                            "full_name" => "Admin User",');
console.log('                            "role" => "admin",');
console.log('                            "permissions" => [');
console.log('                                "admin" => true,');
console.log('                                "users" => true,');
console.log('                                "packages" => true,');
console.log('                                "destinations" => true');
console.log('                            ]');
console.log('                        ],');
console.log('                        "token" => $token');
console.log('                    ]');
console.log('                ], JSON_UNESCAPED_SLASHES);');
console.log('            } else {');
console.log('                http_response_code(401);');
console.log('                echo json_encode([');
console.log('                    "error" => "Invalid credentials",');
console.log('                    "message" => "Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©"');
console.log('                ], JSON_UNESCAPED_SLASHES);');
console.log('            }');
console.log('            break;');
console.log('');
console.log('        case "/api/auth/me":');
console.log('            // Get token from cookie');
console.log('            $token = $_COOKIE["auth-token"] ?? "";');
console.log('            if (empty($token)) {');
console.log('                http_response_code(401);');
console.log('                echo json_encode(["error" => "No token provided"], JSON_UNESCAPED_SLASHES);');
console.log('                break;');
console.log('            }');
console.log('');
console.log('            // Decode token');
console.log('            $tokenData = json_decode(base64_decode($token), true);');
console.log('            if (!$tokenData || !isset($tokenData["email"])) {');
console.log('                http_response_code(401);');
console.log('                echo json_encode(["error" => "Invalid token"], JSON_UNESCAPED_SLASHES);');
console.log('                break;');
console.log('            }');
console.log('');
console.log('            // Check if token is expired');
console.log('            if (isset($tokenData["exp"]) && $tokenData["exp"] < time()) {');
console.log('                http_response_code(401);');
console.log('                echo json_encode(["error" => "Token expired"], JSON_UNESCAPED_SLASHES);');
console.log('                break;');
console.log('            }');
console.log('');
console.log('            // Return user data');
console.log('            echo json_encode([');
console.log('                "success" => true,');
console.log('                "data" => [');
console.log('                    "user" => [');
console.log('                        "email" => $tokenData["email"],');
console.log('                        "name" => "Admin User",');
console.log('                        "full_name" => "Admin User",');
console.log('                        "role" => $tokenData["role"] ?? "admin",');
console.log('                        "permissions" => [');
console.log('                            "admin" => true,');
console.log('                            "users" => true,');
console.log('                            "packages" => true,');
console.log('                            "destinations" => true');
console.log('                        ]');
console.log('                    ]');
console.log('                ]');
console.log('            ], JSON_UNESCAPED_SLASHES);');
console.log('            break;');
console.log('');
console.log('        case "/api/auth/logout":');
console.log('            // Clear token cookie');
console.log('            setcookie("auth-token", "", time() - 3600, "/", "", false, true);');
console.log('            echo json_encode([');
console.log('                "success" => true,');
console.log('                "message" => "Logged out successfully"');
console.log('            ], JSON_UNESCAPED_SLASHES);');
console.log('            break;');
console.log('');
console.log('        case "/api/packages":');
console.log('            $packages = [');
console.log('                [');
console.log('                    "id" => 1,');
console.log('                    "title" => "Dubai Luxury Package",');
console.log('                    "description" => "Experience the luxury of Dubai with our premium package",');
console.log('                    "price" => 2500,');
console.log('                    "duration" => "7 days",');
console.log('                    "image" => "/images/packages/dubai-luxury.jpg",');
console.log('                    "featured" => true,');
console.log('                    "destination" => "Dubai, UAE"');
console.log('                ],');
console.log('                [');
console.log('                    "id" => 2,');
console.log('                    "title" => "Bali Paradise",');
console.log('                    "description" => "Discover the beauty of Bali with our tropical package",');
console.log('                    "price" => 1800,');
console.log('                    "duration" => "5 days",');
console.log('                    "image" => "/images/packages/bali-paradise.jpg",');
console.log('                    "featured" => true,');
console.log('                    "destination" => "Bali, Indonesia"');
console.log('                ]');
console.log('            ];');
console.log('            echo json_encode($packages, JSON_UNESCAPED_SLASHES);');
console.log('            break;');
console.log('');
console.log('        case "/api/cms/site-settings":');
console.log('            $settings = [');
console.log('                "site_name" => "World Trip Agency",');
console.log('                "site_description" => "Your premier travel partner",');
console.log('                "contact_email" => "info@worldtripagency.com",');
console.log('                "contact_phone" => "+966 50 123 4567"');
console.log('            ];');
console.log('            echo json_encode($settings, JSON_UNESCAPED_SLASHES);');
console.log('            break;');
console.log('');
console.log('        case "/api/test":');
console.log('            echo json_encode([');
console.log('                "message" => "API is working",');
console.log('                "timestamp" => date("Y-m-d H:i:s"),');
console.log('                "path" => $path');
console.log('            ], JSON_UNESCAPED_SLASHES);');
console.log('            break;');
console.log('');
console.log('        default:');
console.log('            http_response_code(404);');
console.log('            echo json_encode([');
console.log('                "error" => "API endpoint not found",');
console.log('                "path" => $path');
console.log('            ], JSON_UNESCAPED_SLASHES);');
console.log('            break;');
console.log('    }');
console.log('} catch (Exception $e) {');
console.log('    http_response_code(500);');
console.log('    echo json_encode([');
console.log('        "error" => "Internal server error",');
console.log('        "message" => $e->getMessage()');
console.log('    ], JSON_UNESCAPED_SLASHES);');
console.log('}');
console.log('?>');
console.log('EOF');
console.log('');
console.log('# 2. Replace the API handler');
console.log('cp api-handler-fixed-structure.php api-handler.php');
console.log('');
console.log('# 3. Test the updated login API');
console.log('curl -k -X POST https://travelin-agency-nlcs.vercel.app/api/auth/login \\');
console.log('  -H "Content-Type: application/json" \\');
console.log('  -d \'{"email":"admin@wonderland.com","password":"admin123"}\'');
console.log('');
console.log('# 4. Test the auth/me endpoint');
console.log('curl -k https://travelin-agency-nlcs.vercel.app/api/auth/me');
console.log('');
console.log('ðŸŽ¯ This will fix:');
console.log('âœ… API response structure matching frontend expectations');
console.log('âœ… Proper user object with all required fields');
console.log('âœ… Token cookie handling');
console.log('âœ… Admin login functionality');
